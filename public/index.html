<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI 심리테스트 자동 생성기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5ff;
      padding: 40px 16px;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
      padding: 32px 24px 40px;
    }
    h1 {
      font-size: 26px;
      font-weight: 800;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #6366f1, #ec4899);
      -webkit-background-clip: text;
      color: transparent;
    }
    .subtitle {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 24px;
    }
    .tabs {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 8px;
      margin-bottom: 20px;
    }
    .tab {
      flex-shrink: 0;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 13px;
      color: #4b5563;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }
    .tab.active {
      background: linear-gradient(135deg, #6366f1, #ec4899);
      color: white;
      border-color: transparent;
      box-shadow: 0 6px 18px rgba(99,102,241,0.3);
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
    }
    button.primary, button.outline {
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s ease;
    }
    button.primary {
      background: linear-gradient(135deg, #6366f1, #ec4899);
      color: white;
      box-shadow: 0 8px 20px rgba(99,102,241,0.35);
    }
    button.primary:hover { transform: translateY(-1px); }
    button.outline {
      background: white;
      border: 1px solid #e5e7eb;
      color: #374151;
    }
    button.outline:hover { background:#f9fafb; }

    .result-box {
      margin-top: 20px;
      padding: 20px 16px;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      max-height: 520px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-size: 14px;
      line-height: 1.5;
      color: #111827;
    }
    .placeholder {
      margin-top: 32px;
      font-size: 14px;
      color: #9ca3af;
      text-align: center;
    }

    /* 저장된 테스트 목록 */
    .saved-tests-box {
      margin-top: 28px;
      padding: 16px 16px 8px;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      background: #fdfdff;
    }
    .saved-tests-title {
      font-size: 14px;
      font-weight: 600;
      color: #4b5563;
      margin-bottom: 10px;
    }
    .saved-item {
      padding: 10px 12px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .saved-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .saved-item-category {
      font-size: 13px;
      font-weight: 600;
      color: #374151;
    }
    .saved-item-date {
      font-size: 11px;
      color: #9ca3af;
    }
    .saved-item-buttons {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }
    .saved-item-buttons button {
      flex: none;
      padding: 4px 10px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: white;
      cursor: pointer;
    }
    .saved-item-buttons button:hover {
      background:#f3f4ff;
    }

    /* 테스트 풀이 UI */
    .quiz-box {
      margin-top: 32px;
      padding: 20px 18px 18px;
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      background: linear-gradient(135deg, #f9fafb, #eef2ff);
    }
    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .quiz-title {
      font-size: 15px;
      font-weight: 700;
      color: #4b5563;
    }
    .quiz-progress {
      font-size: 12px;
      color: #6b7280;
    }
    .quiz-question {
      font-size: 15px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
      line-height: 1.5;
    }
    .quiz-choices {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 14px;
    }
    .quiz-choice-btn {
      text-align: left;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: white;
      font-size: 13px;
      color: #374151;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .quiz-choice-btn:hover {
      background: #eef2ff;
      border-color: #c7d2fe;
    }
    .quiz-choice-btn.selected {
      background: linear-gradient(135deg, #6366f1, #ec4899);
      border-color: transparent;
      color: white;
      box-shadow: 0 8px 18px rgba(99,102,241,0.4);
    }
    .quiz-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-bottom: 8px;
    }
    .quiz-footer button {
      padding: 6px 14px;
      font-size: 12px;
      border-radius: 999px;
    }
    .quiz-result {
      margin-top: 6px;
      padding-top: 10px;
      border-top: 1px dashed #e5e7eb;
      font-size: 13px;
      color: #374151;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .quiz-ai-result {
      margin-top: 12px;
      padding: 12px 12px 10px;
      border-radius: 14px;
      background: #fff7ed;
      border: 1px solid #fed7aa;
      font-size: 13px;
      color: #7c2d12;
      white-space: pre-wrap;
    }

    @media (min-width: 768px) {
      .container { padding: 32px 32px 40px; }
      h1 { font-size: 30px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>AI 심리테스트 자동 생성기</h1>
    <p class="subtitle">
      카테고리를 고르고 버튼만 누르면, AI가 질문·보기·결과까지 한 번에 만들어 줍니다.
    </p>

    <!-- 카테고리 탭 -->
    <div class="tabs" id="categoryTabs">
      <div class="tab active" data-value="연애 심리테스트">연애 심리테스트</div>
      <div class="tab" data-value="성격 심리테스트">성격 심리테스트</div>
      <div class="tab" data-value="금전/소비 성향 심리테스트">금전/소비 성향 심리테스트</div>
      <div class="tab" data-value="직장/커리어 심리테스트">직장/커리어 심리테스트</div>
      <div class="tab" data-value="우정/대인관계 심리테스트">우정/대인관계 심리테스트</div>
      <div class="tab" data-value="라이프스타일 심리테스트">라이프스타일 심리테스트</div>
    </div>

    <!-- 버튼들 -->
    <div class="controls">
      <button class="primary" id="generateBtn">테스트 생성하기</button>
      <button class="outline" id="regenerateBtn">다시 생성하기</button>
      <button class="outline" id="copyBtn">결과 복사하기</button>
      <button class="outline" id="startQuizBtn">테스트 풀기</button>
    </div>

    <!-- 결과 영역 -->
    <div id="result" class="result-box" style="display:none;"></div>
    <div id="placeholder" class="placeholder">
      위에서 카테고리를 선택하고 <b>테스트 생성하기</b>를 눌러 주세요.
    </div>

    <!-- 테스트 풀이 섹션 -->
    <div id="quizSection" class="quiz-box" style="display:none;">
      <div class="quiz-header">
        <span class="quiz-title">테스트 풀이 모드</span>
        <span class="quiz-progress" id="quizProgress">1 / 1</span>
      </div>
      <div class="quiz-question" id="quizQuestion">
        질문이 여기에 표시됩니다.
      </div>
      <div class="quiz-choices" id="quizChoices"></div>
      <div class="quiz-footer">
        <button class="outline" id="quizPrevBtn">이전</button>
        <button class="outline" id="quizNextBtn">다음</button>
        <button class="primary" id="quizSubmitBtn">결과 요약 & AI 해석 보기</button>
      </div>
      <div class="quiz-result" id="quizResult" style="display:none;"></div>
      <div class="quiz-ai-result" id="quizAiResult" style="display:none;"></div>
    </div>

    <!-- 저장된 테스트 목록 -->
    <div id="savedTestsSection" class="saved-tests-box"></div>
  </div>

  <script>
    /***********************
     *  저장/불러오기 관련 함수
     ***********************/
    function saveTest(category, content) {
      const saved = JSON.parse(localStorage.getItem("aiPsychTests") || "[]");

      const newTest = {
        id: `test_${Date.now()}`,
        category,
        content,
        createdAt: new Date().toLocaleString()
      };

      saved.unshift(newTest);
      if (saved.length > 20) {
        saved.pop();
      }

      localStorage.setItem("aiPsychTests", JSON.stringify(saved));
    }

    function loadSavedTests() {
      return JSON.parse(localStorage.getItem("aiPsychTests") || "[]");
    }

    function renderSavedTests() {
      const list = loadSavedTests();
      const box = document.getElementById("savedTestsSection");
      if (!box) return;

      if (list.length === 0) {
        box.innerHTML = '<div class="saved-tests-title">저장된 테스트</div><p style="font-size:12px; color:#9ca3af;">아직 저장된 테스트가 없습니다.</p>';
        return;
      }

      box.innerHTML =
        '<div class="saved-tests-title">저장된 테스트</div>' +
        list
          .map(
            (t) => `
          <div class="saved-item">
            <div class="saved-item-header">
              <span class="saved-item-category">${t.category}</span>
              <span class="saved-item-date">${t.createdAt}</span>
            </div>
            <div class="saved-item-buttons">
              <button onclick="openSavedTest('${t.id}')">열기</button>
              <button onclick="deleteSavedTest('${t.id}')">삭제</button>
            </div>
          </div>
        `
          )
          .join("");
    }

    let currentTestCategory = null;

    function openSavedTest(id) {
      const list = loadSavedTests();
      const t = list.find((x) => x.id === id);
      if (!t) {
        alert("저장된 테스트를 찾을 수 없습니다.");
        return;
      }

      const resultBox = document.getElementById('result');
      const placeholder = document.getElementById('placeholder');

      resultBox.style.display = 'block';
      placeholder.style.display = 'none';
      resultBox.textContent = t.content;
      currentTestCategory = t.category || null;

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteSavedTest(id) {
      let list = loadSavedTests();
      list = list.filter((x) => x.id !== id);
      localStorage.setItem("aiPsychTests", JSON.stringify(list));
      renderSavedTests();
    }

    /***********************
     *  테스트 풀이용 로직
     ***********************/
    const startQuizBtn = document.getElementById('startQuizBtn');
    const quizSection = document.getElementById('quizSection');
    const quizQuestionEl = document.getElementById('quizQuestion');
    const quizChoicesEl = document.getElementById('quizChoices');
    const quizProgressEl = document.getElementById('quizProgress');
    const quizPrevBtn = document.getElementById('quizPrevBtn');
    const quizNextBtn = document.getElementById('quizNextBtn');
    const quizSubmitBtn = document.getElementById('quizSubmitBtn');
    const quizResultEl = document.getElementById('quizResult');
    const quizAiResultEl = document.getElementById('quizAiResult');

    let parsedQuestions = [];
    let currentQuestionIndex = 0;
    let userAnswers = [];  // 각 문항의 선택 인덱스 (0~3)

    function parseTestTextToQuestions(text) {
      const lines = text
        .split('\n')
        .map(l => l.trim())
        .filter(l => l.length > 0);

      const questions = [];
      let current = null;

      for (const line of lines) {
        if (line.includes('결과 해석') || line.includes('결과 유형') || line.startsWith('[결과')) {
          break;
        }

        const qMatch = /^(\d+)[\.\)]\s*(.*)/.exec(line);
        const aMatch = /^([A-D])[)\.\-]\s*(.*)/.exec(line);

        if (qMatch) {
          if (current && current.choices.length > 0) {
            questions.push(current);
          }
          current = {
            number: qMatch[1],
            question: qMatch[2].trim(),
            choices: []
          };
        } else if (aMatch && current) {
          current.choices.push(`${aMatch[1]}) ${aMatch[2].trim()}`);
        }
      }

      if (current && current.choices.length > 0) {
        questions.push(current);
      }

      return questions;
    }

    function renderQuizQuestion() {
      if (!parsedQuestions.length) return;

      const q = parsedQuestions[currentQuestionIndex];
      quizProgressEl.textContent = `${currentQuestionIndex + 1} / ${parsedQuestions.length}`;
      quizQuestionEl.textContent = `Q${q.number}. ${q.question}`;

      quizChoicesEl.innerHTML = '';
      q.choices.forEach((choiceText, idx) => {
        const btn = document.createElement('button');
        btn.className = 'quiz-choice-btn';
        if (userAnswers[currentQuestionIndex] === idx) {
          btn.classList.add('selected');
        }
        btn.textContent = choiceText;

        btn.addEventListener('click', () => {
          userAnswers[currentQuestionIndex] = idx;
          renderQuizQuestion();
        });

        quizChoicesEl.appendChild(btn);
      });

      quizPrevBtn.disabled = currentQuestionIndex === 0;
      quizNextBtn.disabled = currentQuestionIndex === parsedQuestions.length - 1;
    }

    function startQuiz() {
      const resultBox = document.getElementById('result');
      const text = resultBox.textContent.trim();
      if (!text) {
        alert('먼저 테스트를 생성한 뒤 이용해 주세요.');
        return;
      }

      const qs = parseTestTextToQuestions(text);
      if (!qs.length) {
        alert('현재 생성된 텍스트에서 문항을 찾지 못했습니다. 다시 생성 후 시도해 주세요.');
        return;
      }

      parsedQuestions = qs;
      userAnswers = new Array(qs.length).fill(null);
      currentQuestionIndex = 0;
      quizResultEl.style.display = 'none';
      quizAiResultEl.style.display = 'none';
      quizAiResultEl.textContent = '';

      quizSection.style.display = 'block';
      renderQuizQuestion();

      window.scrollTo({
        top: quizSection.offsetTop - 40,
        behavior: 'smooth'
      });
    }

    startQuizBtn.addEventListener('click', startQuiz);

    quizPrevBtn.addEventListener('click', () => {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuizQuestion();
      }
    });

    quizNextBtn.addEventListener('click', () => {
      if (currentQuestionIndex < parsedQuestions.length - 1) {
        currentQuestionIndex++;
        renderQuizQuestion();
      }
    });

    async function requestAiAnalysis(summary) {
      try {
        const resultBox = document.getElementById('result');
        const testText = resultBox.textContent;

        quizAiResultEl.style.display = 'block';
        quizAiResultEl.textContent = 'AI가 당신의 결과를 분석하는 중입니다... (1~3초 정도 걸릴 수 있어요)';

        const res = await fetch('/api/analyze-result', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            category: currentTestCategory || selectedCategory,
            testText,
            summary
          })
        });

        if (!res.ok) {
          throw new Error('결과 해석 API 오류');
        }

        const data = await res.json();
        const text = typeof data.result === 'string' ? data.result : JSON.stringify(data.result, null, 2);
        quizAiResultEl.innerHTML = '<b>AI 엔터테인먼트 해석</b>\n\n' + text;
      } catch (err) {
        console.error(err);
        quizAiResultEl.textContent = 'AI 해석 중 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.';
      }
    }

    quizSubmitBtn.addEventListener('click', () => {
      if (!parsedQuestions.length) return;

      const counts = { A: 0, B: 0, C: 0, D: 0 };

      parsedQuestions.forEach((q, idx) => {
        const answerIdx = userAnswers[idx];
        if (answerIdx == null) return;
        const choiceText = q.choices[answerIdx];
        const letter = choiceText.trim().charAt(0); // A/B/C/D
        if (counts[letter] !== undefined) {
          counts[letter]++;
        }
      });

      const entries = Object.entries(counts);
      const totalAnswered = entries.reduce((sum, [, v]) => sum + v, 0);

      const unanswered = parsedQuestions.length - totalAnswered;
      if (unanswered > 0) {
        const ok = confirm(`답을 고르지 않은 문항이 ${unanswered}개 있습니다. 그대로 결과를 보시겠어요?`);
        if (!ok) return;
      }

      let bestLetter = null;
      let bestCount = -1;
      for (const [letter, count] of entries) {
        if (count > bestCount) {
          bestLetter = letter;
          bestCount = count;
        }
      }

      const summaryText =
        '선택 결과 요약\n' +
        `총 ${parsedQuestions.length}문항 중 ${totalAnswered}문항에 답변했습니다.\n` +
        `A 선택: ${counts.A}개, B 선택: ${counts.B}개, C 선택: ${counts.C}개, D 선택: ${counts.D}개\n\n` +
        `가장 많이 선택한 유형: ${bestLetter || '-'} 타입\n` +
        '상세 해석은 아래 AI 엔터테인먼트 분석을 참고해 주세요.';

      quizResultEl.style.display = 'block';
      quizResultEl.textContent = summaryText;

      const summaryForServer = {
        totalQuestions: parsedQuestions.length,
        totalAnswered,
        counts
      };

      requestAiAnalysis(summaryForServer);
    });

    /***********************
     *  기존 생성/복사 기능
     ***********************/
    const tabs = document.querySelectorAll('.tab');
    const generateBtn = document.getElementById('generateBtn');
    const regenerateBtn = document.getElementById('regenerateBtn');
    const copyBtn = document.getElementById('copyBtn');
    const resultBox = document.getElementById('result');
    const placeholder = document.getElementById('placeholder');

    let selectedCategory = '연애 심리테스트';
    let lastPayload = null;

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        selectedCategory = tab.dataset.value;
      });
    });

    async function callApi(category) {
      resultBox.style.display = 'block';
      resultBox.textContent = 'AI가 심리테스트를 만드는 중입니다...\n(잠시만 기다려 주세요)';
      placeholder.style.display = 'none';
      quizSection.style.display = 'none';

      quizResultEl.style.display = 'none';
      quizAiResultEl.style.display = 'none';
      quizAiResultEl.textContent = '';

      try {
        const res = await fetch('/api/generate-test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ category })
        });

        if (!res.ok) {
          throw new Error('API 요청 실패');
        }

        const data = await res.json();

        const text =
          typeof data.test === 'string'
            ? data.test
            : JSON.stringify(data.test, null, 2);

        resultBox.textContent = text;
        lastPayload = text;
        currentTestCategory = category;

        saveTest(category, text);
        renderSavedTests();
      } catch (err) {
        console.error(err);
        resultBox.textContent = '오류가 발생했습니다. 잠시 후 다시 시도해 주세요.';
      }
    }

    generateBtn.addEventListener('click', () => {
      callApi(selectedCategory);
    });

    regenerateBtn.addEventListener('click', () => {
      callApi(selectedCategory);
    });

    copyBtn.addEventListener('click', async () => {
      if (!resultBox.textContent.trim()) return;
      try {
        await navigator.clipboard.writeText(resultBox.textContent);
        alert('결과가 클립보드에 복사되었습니다!');
      } catch (e) {
        alert('복사 중 오류가 발생했습니다. (모바일/브라우저 설정을 확인해 주세요)');
      }
    });

    renderSavedTests();
  </script>
</body>
</html>
