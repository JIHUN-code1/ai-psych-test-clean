<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>심마켓 관리자 – 통계 대시보드</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      background: #0f172a;
      color: #e5e7eb;
      padding: 20px 12px 40px;
    }
    .layout {
      max-width: 1120px;
      margin: 0 auto;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .brand-logo {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: radial-gradient(circle at 20% 0%, #fb7185, #f97316 40%, #6366f1 80%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      font-weight: 900;
      box-shadow: 0 10px 24px rgba(248, 113, 113, 0.6);
    }
    .brand-main {
      font-size: 18px;
      font-weight: 800;
    }
    .brand-sub {
      font-size: 11px;
      color: #9ca3af;
    }
    .header-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn {
      font-size: 12px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid #475569;
      background: #020617;
      color: #e5e7eb;
      text-decoration: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn.primary {
      background: linear-gradient(135deg, #6366f1, #ec4899);
      border-color: transparent;
    }

    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
    }
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      border-radius: 20px;
      padding: 18px 16px 18px;
      background: radial-gradient(circle at top left, #1f2937, #020617);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
      border: 1px solid #1f2937;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }
    .card-title {
      font-size: 15px;
      font-weight: 700;
    }
    .card-sub {
      font-size: 11px;
      color: #9ca3af;
    }

    .chip {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #4b5563;
      color: #e5e7eb;
    }

    .stat-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .stat-box {
      flex: 1;
      min-width: 120px;
      border-radius: 14px;
      padding: 8px 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid #374151;
    }
    .stat-label {
      font-size: 11px;
      color: #9ca3af;
    }
    .stat-value {
      font-size: 16px;
      font-weight: 800;
      margin-top: 4px;
    }

    .table-wrap {
      margin-top: 10px;
      max-height: 360px;
      overflow: auto;
      border-radius: 14px;
      border: 1px solid #1f2937;
      background: rgba(15, 23, 42, 0.85);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid #111827;
      white-space: nowrap;
    }
    th {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.7);
    }

    .badge-hot {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(248, 113, 113, 0.18);
      color: #fecaca;
    }

    canvas {
      width: 100% !important;
      height: 260px !important;
    }
  </style>
</head>
<body>
  <div class="layout">
    <header>
      <div class="brand">
        <div class="brand-logo">심</div>
        <div>
          <div class="brand-main">심마켓 관리자 통계</div>
          <div class="brand-sub">테스트별 조회수·참여수 한눈에 보기</div>
        </div>
      </div>
      <div class="header-actions">
        <a href="/admin" class="btn">← 관리자 홈</a>
        <a href="/home" class="btn">서비스 홈 보기</a>
        <button id="btnRefresh" class="btn primary">데이터 새로고침</button>
      </div>
    </header>

    <div class="grid">
      <!-- 좌측: 그래프 -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">테스트별 조회/참여 추이</div>
            <div class="card-sub">상위 10개 테스트 기준 · 파란선=조회수, 보라선=참여수</div>
          </div>
          <span class="chip" id="chipSummary">테스트 0개</span>
        </div>
        <canvas id="statsChart"></canvas>
      </section>

      <!-- 우측: 총괄 요약 + 표 -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">요약 지표</div>
            <div class="card-sub">전체 누적 기준</div>
          </div>
        </div>

        <div class="stat-row">
          <div class="stat-box">
            <div class="stat-label">전체 테스트 수</div>
            <div class="stat-value" id="statTotalTests">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">총 조회수(views)</div>
            <div class="stat-value" id="statTotalViews">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">총 참여수(plays)</div>
            <div class="stat-value" id="statTotalPlays">0</div>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>제목</th>
                <th>카테고리</th>
                <th>조회수</th>
                <th>참여수</th>
                <th>참여율</th>
                <th>등록일</th>
                <th>HOT</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr>
                <td colspan="7" style="text-align:center;color:#9ca3af;">불러오는 중...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const btnRefresh = document.getElementById('btnRefresh');
    const chipSummary = document.getElementById('chipSummary');
    const statTotalTests = document.getElementById('statTotalTests');
    const statTotalViews = document.getElementById('statTotalViews');
    const statTotalPlays = document.getElementById('statTotalPlays');
    const tableBody = document.getElementById('tableBody');
    const ctx = document.getElementById('statsChart').getContext('2d');

    let chart;

    function formatNumber(num) {
      if (!num) return '0';
      return num.toLocaleString('ko-KR');
    }

    function formatDate(iso) {
      if (!iso) return '-';
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return '-';
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    async function loadStats() {
      try {
        btnRefresh.textContent = '불러오는 중...';
        btnRefresh.disabled = true;

        const res = await fetch('/api/tests');
        if (!res.ok) throw new Error('API error');
        const tests = await res.json();

        // 기본값 보정
        tests.forEach(t => {
          t.views = typeof t.views === 'number' ? t.views : 0;
          t.plays = typeof t.plays === 'number' ? t.plays : 0;
        });

        // 요약 지표
        const totalTests = tests.length;
        const totalViews = tests.reduce((sum, t) => sum + (t.views || 0), 0);
        const totalPlays = tests.reduce((sum, t) => sum + (t.plays || 0), 0);

        statTotalTests.textContent = formatNumber(totalTests);
        statTotalViews.textContent = formatNumber(totalViews);
        statTotalPlays.textContent = formatNumber(totalPlays);
        chipSummary.textContent = `테스트 ${totalTests}개 · 총 조회 ${formatNumber(totalViews)} · 참여 ${formatNumber(totalPlays)}`;

        // 표 렌더링 (조회수 기준 내림차순)
        tests.sort((a, b) => (b.views || 0) - (a.views || 0));

        if (!tests.length) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align:center;color:#9ca3af;">등록된 테스트가 없습니다.</td>
            </tr>
          `;
        } else {
          tableBody.innerHTML = tests.map(t => {
            const views = t.views || 0;
            const plays = t.plays || 0;
            const rate = views > 0 ? ((plays / views) * 100).toFixed(1) + '%' : '-';
            const safeTitle = (t.title || '제목 없음').slice(0, 16);
            const category = t.category || '-';

            return `
              <tr>
                <td title="${t.title || ''}">${safeTitle}</td>
                <td>${category}</td>
                <td>${formatNumber(views)}</td>
                <td>${formatNumber(plays)}</td>
                <td>${rate}</td>
                <td>${formatDate(t.createdAt)}</td>
                <td>${t.isHot ? '<span class="badge-hot">HOT</span>' : ''}</td>
              </tr>
            `;
          }).join('');
        }

        // 상위 10개로 차트 데이터 생성
        const top = tests.slice(0, 10);
        const labels = top.map((t, idx) => `${idx + 1}. ${(t.title || '제목 없음').slice(0, 10)}`);
        const dataViews = top.map(t => t.views || 0);
        const dataPlays = top.map(t => t.plays || 0);

        // 차트 생성/업데이트
        if (chart) {
          chart.data.labels = labels;
          chart.data.datasets[0].data = dataViews;
          chart.data.datasets[1].data = dataPlays;
          chart.update();
        } else {
          chart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [
                {
                  label: '조회수(views)',
                  data: dataViews,
                  backgroundColor: 'rgba(59,130,246,0.7)'
                },
                {
                  label: '참여수(plays)',
                  data: dataPlays,
                  backgroundColor: 'rgba(147,51,234,0.7)'
                }
              ]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  labels: {
                    color: '#e5e7eb',
                    font: { size: 11 }
                  }
                }
              },
              scales: {
                x: {
                  ticks: {
                    color: '#9ca3af',
                    font: { size: 10 }
                  },
                  grid: {
                    color: 'rgba(31,41,55,0.7)'
                  }
                },
                y: {
                  ticks: {
                    color: '#9ca3af',
                    font: { size: 10 },
                    callback: value => formatNumber(value)
                  },
                  grid: {
                    color: 'rgba(31,41,55,0.7)'
                  }
                }
              }
            }
          });
        }

      } catch (e) {
        console.error(e);
        chipSummary.textContent = '데이터를 불러오지 못했습니다.';
        tableBody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align:center;color:#fca5a5;">API 호출 중 오류가 발생했습니다.</td>
          </tr>
        `;
      } finally {
        btnRefresh.textContent = '데이터 새로고침';
        btnRefresh.disabled = false;
      }
    }

    btnRefresh.addEventListener('click', loadStats);

    // 초기 로드
    loadStats();
  </script>
</body>
</html>
