<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ ìë™ ìƒì„±ê¸° | AI Psych Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="AIê°€ ì—°ì• Â·ì„±ê²©Â·ê¸ˆì „Â·ì§ì¥Â·ìš°ì •Â·ë¼ì´í”„ìŠ¤íƒ€ì¼ ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ë¥¼ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ê³ , ê²°ê³¼ê¹Œì§€ ì—”í„°í…Œì¸ë¨¼íŠ¸ ìŠ¤íƒ€ì¼ë¡œ í•´ì„í•´ì£¼ëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤." />

  <!-- SNS/ì¹´ì¹´ì˜¤/í˜ë¶ ë“± ê³µìœ  ë¯¸ë¦¬ë³´ê¸°ìš© -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="AI ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ ìë™ ìƒì„±ê¸°" />
  <meta property="og:description" content="ë²„íŠ¼ í•œ ë²ˆìœ¼ë¡œ ë‚˜ë§Œì˜ ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“¤ê³ , í…ŒìŠ¤íŠ¸ í’€ê¸° + AI í•´ì„ + ê²°ê³¼ ì¹´ë“œ ì´ë¯¸ì§€ê¹Œì§€ í•œ ë²ˆì—!" />
  <meta property="og:url" content="https://ai-psych-test-clean.onrender.com/" />
  <!-- ì¸ë„¤ì¼ ì´ë¯¸ì§€ëŠ” ë‚˜ì¤‘ì— /public/og-image.png ê°™ì€ íŒŒì¼ì„ ì˜¬ë ¤ì„œ ë³€ê²½í•´ë„ ë¨ -->
  <meta property="og:image" content="/og-image.png" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="AI ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ ìë™ ìƒì„±ê¸°" />
  <meta name="twitter:description" content="AIê°€ ë§Œë“¤ì–´ì£¼ëŠ” ê³ í€„ë¦¬í‹° ì‹¬ë¦¬í…ŒìŠ¤íŠ¸, ë§í¬ ê³µìœ ë¡œ ì¹œêµ¬ì™€ ê°™ì´ ì¦ê²¨ë³´ì„¸ìš”!" />
  <meta name="twitter:image" content="/og-image.png" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5ff;
      padding: 40px 16px;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
      padding: 32px 24px 40px;
    }
    h1 {
      font-size: 26px;
      font-weight: 800;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #6366f1, #ec4899);
      -webkit-background-clip: text;
      color: transparent;
    }
    .subtitle {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 24px;
    }
    .tabs {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 8px;
      margin-bottom: 20px;
    }
    .tab {
      flex-shrink: 0;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 13px;
      color: #4b5563;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }
    .tab.active {
      background: linear-gradient(135deg, #6366f1, #ec4899);
      color: white;
      border-color: transparent;
      box-shadow: 0 6px 18px rgba(99,102,241,0.3);
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
    }
    button.primary, button.outline {
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s ease;
    }
    button.primary {
      background: linear-gradient(135deg, #6366f1, #ec4899);
      color: white;
      box-shadow: 0 8px 20px rgba(99,102,241,0.35);
    }
    button.primary:hover { transform: translateY(-1px); }
    button.outline {
      background: white;
      border: 1px solid #e5e7eb;
      color: #374151;
    }
    button.outline:hover { background:#f9fafb; }

    .result-box {
      margin-top: 20px;
      padding: 20px 16px;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      max-height: 520px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-size: 14px;
      line-height: 1.5;
      color: #111827;
    }
    .placeholder {
      margin-top: 32px;
      font-size: 14px;
      color: #9ca3af;
      text-align: center;
    }

    /* ê³µìœ  ë§í¬ ì•ˆë‚´ ë°°ë„ˆ */
    .share-notice {
      display: none;
      margin-bottom: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #eef2ff;
      border: 1px solid #c7d2fe;
      font-size: 12px;
      color: #4338ca;
    }

    /* ì €ì¥ëœ í…ŒìŠ¤íŠ¸ ëª©ë¡ */
    .saved-tests-box {
      margin-top: 28px;
      padding: 16px 16px 8px;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      background: #fdfdff;
    }
    .saved-tests-title {
      font-size: 14px;
      font-weight: 600;
      color: #4b5563;
      margin-bottom: 10px;
    }
    .saved-item {
      padding: 10px 12px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .saved-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .saved-item-category {
      font-size: 13px;
      font-weight: 600;
      color: #374151;
    }
    .saved-item-date {
      font-size: 11px;
      color: #9ca3af;
    }
    .saved-item-buttons {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }
    .saved-item-buttons button {
      flex: none;
      padding: 4px 10px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: white;
      cursor: pointer;
    }
    .saved-item-buttons button:hover {
      background:#f3f4ff;
    }

    /* í…ŒìŠ¤íŠ¸ í’€ì´ UI */
    .quiz-box {
      margin-top: 32px;
      padding: 20px 18px 18px;
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      background: linear-gradient(135deg, #f9fafb, #eef2ff);
    }
    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .quiz-title {
      font-size: 15px;
      font-weight: 700;
      color: #4b5563;
    }
    .quiz-progress {
      font-size: 12px;
      color: #6b7280;
    }
    .quiz-question {
      font-size: 15px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
      line-height: 1.5;
    }
    .quiz-choices {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 14px;
    }
    .quiz-choice-btn {
      text-align: left;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: white;
      font-size: 13px;
      color: #374151;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .quiz-choice-btn:hover {
      background: #eef2ff;
      border-color: #c7d2fe;
    }
    .quiz-choice-btn.selected {
      background: linear-gradient(135deg, #6366f1, #ec4899);
      border-color: transparent;
      color: white;
      box-shadow: 0 8px 18px rgba(99,102,241,0.4);
    }
    .quiz-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-bottom: 8px;
    }
    .quiz-footer button {
      padding: 6px 14px;
      font-size: 12px;
      border-radius: 999px;
    }
    .quiz-result {
      margin-top: 6px;
      padding-top: 10px;
      border-top: 1px dashed #e5e7eb;
      font-size: 13px;
      color: #374151;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .quiz-ai-result {
      margin-top: 12px;
      padding: 12px 12px 10px;
      border-radius: 14px;
      background: #fff7ed;
      border: 1px solid #fed7aa;
      font-size: 13px;
      color: #7c2d12;
      white-space: pre-wrap;
    }

    /* ê²°ê³¼ ì¹´ë“œ (ì´ë¯¸ì§€ìš©) */
    .result-card-wrapper {
      margin-top: 18px;
      display: none;
    }
    .result-card {
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
      padding: 18px 20px 16px;
      border-radius: 24px;
      background: linear-gradient(135deg, #eef2ff, #fdf2ff);
      border: 1px solid #e5e7ff;
      box-shadow: 0 12px 30px rgba(148,163,184,0.45);
      color: #111827;
      font-size: 13px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 11px;
      color: #6b7280;
    }
    .card-badge {
      padding: 3px 10px;
      border-radius: 999px;
      background: #4f46e5;
      color: #e5e7ff;
      font-size: 11px;
      font-weight: 600;
    }
    .card-date {
      font-size: 11px;
    }
    .card-title {
      font-size: 17px;
      font-weight: 800;
      color: #111827;
      margin-bottom: 6px;
    }
    .card-subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 10px;
    }
    .card-body {
      font-size: 12px;
      color: #111827;
      line-height: 1.5;
      margin-bottom: 10px;
    }
    .card-ai-snippet {
      font-size: 12px;
      color: #4b5563;
      line-height: 1.5;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.6);
      border: 1px dashed rgba(148,163,184,0.6);
      margin-bottom: 10px;
    }
    .card-footer {
      font-size: 11px;
      color: #6b7280;
      text-align: right;
    }

    @media (min-width: 768px) {
      .container { padding: 32px 32px 40px; }
      h1 { font-size: 30px; }
    }
  </style>
</head>
<body>
  <!-- ìƒë‹¨ ë¸Œëœë”© ë°” -->
  <div style="max-width:960px;margin:0 auto 12px auto;display:flex;justify-content:space-between;align-items:center;padding:0 4px;">
    <div style="display:flex;align-items:center;gap:8px;">
      <div style="width:26px;height:26px;border-radius:999px;background:linear-gradient(135deg,#6366f1,#ec4899);display:flex;align-items:center;justify-content:center;color:white;font-size:15px;font-weight:800;">
        Ïˆ
      </div>
      <div style="display:flex;flex-direction:column;">
        <span style="font-size:13px;font-weight:700;color:#111827;">AI ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ ìŠ¤íŠœë””ì˜¤</span>
        <span style="font-size:11px;color:#9ca3af;">ë‚˜ë§Œì˜ í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“¤ê³  ì¹œêµ¬ì™€ ê³µìœ í•´ ë³´ì„¸ìš”</span>
      </div>
    </div>
    <span style="font-size:11px;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#4f46e5;border:1px solid #c7d2fe;">
      Beta ì„œë¹„ìŠ¤
    </span>
  </div>

  <!-- ë©”ì¸ ì¹´ë“œ -->
  <div class="container">
    <h1>AI ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ ìë™ ìƒì„±ê¸°</h1>
    <p class="subtitle">
      ì¹´í…Œê³ ë¦¬ë¥¼ ê³ ë¥´ê³  ë²„íŠ¼ë§Œ ëˆ„ë¥´ë©´, AIê°€ ì§ˆë¬¸Â·ë³´ê¸°Â·ê²°ê³¼ê¹Œì§€ í•œ ë²ˆì— ë§Œë“¤ì–´ ì¤ë‹ˆë‹¤.
    </p>

    <!-- ê³µìœ  ë§í¬ ì•ˆë‚´ -->
    <div id="shareNotice" class="share-notice">
      ê³µìœ  ë§í¬ë¡œ ë¶ˆëŸ¬ì˜¨ ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤. ë°”ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ í’€ì–´ë³´ê±°ë‚˜, ìƒˆë¡œ ìƒì„±í•´ì„œ ì‚¬ìš©í•´ë„ ì¢‹ì•„ìš”!
    </div>

    <!-- ì¹´í…Œê³ ë¦¬ íƒ­ -->
    <div class="tabs" id="categoryTabs">
      <div class="tab active" data-value="ì—°ì•  ì‹¬ë¦¬í…ŒìŠ¤íŠ¸">ì—°ì•  ì‹¬ë¦¬í…ŒìŠ¤íŠ¸</div>
      <div class="tab" data-value="ì„±ê²© ì‹¬ë¦¬í…ŒìŠ¤íŠ¸">ì„±ê²© ì‹¬ë¦¬í…ŒìŠ¤íŠ¸</div>
      <div class="tab" data-value="ê¸ˆì „/ì†Œë¹„ ì„±í–¥ ì‹¬ë¦¬í…ŒìŠ¤íŠ¸">ê¸ˆì „/ì†Œë¹„ ì„±í–¥ ì‹¬ë¦¬í…ŒìŠ¤íŠ¸</div>
      <div class="tab" data-value="ì§ì¥/ì»¤ë¦¬ì–´ ì‹¬ë¦¬í…ŒìŠ¤íŠ¸">ì§ì¥/ì»¤ë¦¬ì–´ ì‹¬ë¦¬í…ŒìŠ¤íŠ¸</div>
      <div class="tab" data-value="ìš°ì •/ëŒ€ì¸ê´€ê³„ ì‹¬ë¦¬í…ŒìŠ¤íŠ¸">ìš°ì •/ëŒ€ì¸ê´€ê³„ ì‹¬ë¦¬í…ŒìŠ¤íŠ¸</div>
      <div class="tab" data-value="ë¼ì´í”„ìŠ¤íƒ€ì¼ ì‹¬ë¦¬í…ŒìŠ¤íŠ¸">ë¼ì´í”„ìŠ¤íƒ€ì¼ ì‹¬ë¦¬í…ŒìŠ¤íŠ¸</div>
    </div>

    <!-- ë²„íŠ¼ë“¤ -->
    <div class="controls">
      <button class="primary" id="generateBtn">í…ŒìŠ¤íŠ¸ ìƒì„±í•˜ê¸°</button>
      <button class="outline" id="regenerateBtn">ë‹¤ì‹œ ìƒì„±í•˜ê¸°</button>
      <button class="outline" id="copyBtn">ê²°ê³¼ ë³µì‚¬í•˜ê¸°</button>
      <button class="outline" id="shareLinkBtn">ê³µìœ  ë§í¬ ë³µì‚¬</button>
      <button class="outline" id="startQuizBtn">í…ŒìŠ¤íŠ¸ í’€ê¸°</button>
    </div>

    <!-- ê²°ê³¼ ì˜ì—­ -->
    <div id="result" class="result-box" style="display:none;"></div>
    <div id="placeholder" class="placeholder">
      ìœ„ì—ì„œ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ê³  <b>í…ŒìŠ¤íŠ¸ ìƒì„±í•˜ê¸°</b>ë¥¼ ëˆŒëŸ¬ ì£¼ì„¸ìš”.
    </div>

    <!-- í…ŒìŠ¤íŠ¸ í’€ì´ ì„¹ì…˜ -->
    <div id="quizSection" class="quiz-box" style="display:none;">
      <div class="quiz-header">
        <span class="quiz-title">í…ŒìŠ¤íŠ¸ í’€ì´ ëª¨ë“œ</span>
        <span class="quiz-progress" id="quizProgress">1 / 1</span>
      </div>
      <div class="quiz-question" id="quizQuestion">
        ì§ˆë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
      </div>
      <div class="quiz-choices" id="quizChoices"></div>
      <div class="quiz-footer">
        <button class="outline" id="quizPrevBtn">ì´ì „</button>
        <button class="outline" id="quizNextBtn">ë‹¤ìŒ</button>
        <button class="primary" id="quizSubmitBtn">ê²°ê³¼ ìš”ì•½ & AI í•´ì„ ë³´ê¸°</button>
      </div>
      <div class="quiz-result" id="quizResult" style="display:none;"></div>
      <div class="quiz-ai-result" id="quizAiResult" style="display:none;"></div>

      <!-- ê²°ê³¼ ì¹´ë“œ (ì´ë¯¸ì§€ë¡œ ì €ì¥ë  ì˜ì—­) -->
      <div id="resultCardWrapper" class="result-card-wrapper">
        <div id="resultCard" class="result-card"></div>
      </div>
      <div style="margin-top:8px; text-align:right;">
        <button class="outline" id="downloadImageBtn">ê²°ê³¼ ì¹´ë“œ ì´ë¯¸ì§€ ì €ì¥</button>
      </div>
    </div>

    <!-- ì €ì¥ëœ í…ŒìŠ¤íŠ¸ ëª©ë¡ -->
    <div id="savedTestsSection" class="saved-tests-box"></div>

    <!-- ì´ìš© ì•ˆë‚´ & í‘¸í„° -->
    <div style="margin-top:24px;padding-top:16px;border-top:1px solid #e5e7eb;">
      <div style="font-size:11px;line-height:1.6;color:#6b7280;">
        <div style="font-weight:600;color:#4b5563;margin-bottom:4px;">ì„œë¹„ìŠ¤ ì´ìš© ì•ˆë‚´</div>
        <ul style="padding-left:14px;margin-bottom:6px;">
          <li>ë³¸ ì„œë¹„ìŠ¤ëŠ” <b>ì—”í„°í…Œì¸ë¨¼íŠ¸ ëª©ì ì˜ ì‹¬ë¦¬í…ŒìŠ¤íŠ¸</b>ë¡œ, ì‹¤ì œ ì‹¬ë¦¬ ìƒë‹´Â·ì˜í•™ì  ì§„ë‹¨ì„ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
          <li>ì§ˆë¬¸Â·ê²°ê³¼Â·í•´ì„ ë‚´ìš©ì€ AIê°€ ìë™ìœ¼ë¡œ ìƒì„±í•˜ë©°, <b>ì •í™•ì„±Â·íƒ€ë‹¹ì„±ì´ ë³´ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</b></li>
          <li>ì´ìš© ê³¼ì •ì—ì„œ ì´ë¦„Â·ì—°ë½ì²˜ ë“±ì˜ ë¯¼ê°í•œ ê°œì¸ì •ë³´ëŠ” ìš”êµ¬í•˜ì§€ ì•Šìœ¼ë©°, <b>ë¸Œë¼ìš°ì € ë¡œì»¬ ì €ì¥ì†Œ(localStorage)ì—ë§Œ í…ŒìŠ¤íŠ¸ ë‚´ìš©ì´ ì €ì¥</b>ë©ë‹ˆë‹¤.</li>
          <li>í…ŒìŠ¤íŠ¸ ê³µìœ  ë§í¬ë¥¼ í†µí•´ ì „ë‹¬ë˜ëŠ” ë‚´ìš©ì€ ì‚¬ìš©ìê°€ ìƒì„±í•œ í…ŒìŠ¤íŠ¸ í…ìŠ¤íŠ¸ì— í•œì •ë©ë‹ˆë‹¤.</li>
        </ul>
        <div style="margin-bottom:2px;">
          ì‹¬ë¦¬ì ìœ¼ë¡œ í˜ë“  ìƒí™©ì´ ì§€ì†ëœë‹¤ë©´, ê°€ê¹Œìš´ ì „ë¬¸ ìƒë‹´ ê¸°ê´€Â·ì •ì‹ ê±´ê°•ì˜í•™ê³¼ ë“± <b>ì „ë¬¸ê°€ì˜ ë„ì›€</b>ì„ ê¼­ ë°›ì•„ ë³´ì„¸ìš”.
        </div>
        <div style="margin-top:6px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:4px;">
          <span>ë¬¸ì˜: <a href="mailto:ainam0727@gmail.com" style="color:#4f46e5;text-decoration:none;">ainam0727@gmail.com</a></span>
          <span style="color:#9ca3af;">Â© 2025 AI Psych Test Studio. All rights reserved.</span>
        </div>
      </div>
    </div>
  </div> <!-- .container ë -->

  <!-- html2canvas (ì¹´ë“œ â†’ PNG ë³€í™˜ìš©) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    /***********************
     *  ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ê´€ë ¨ í•¨ìˆ˜
     ***********************/
    function saveTest(category, content) {
      const saved = JSON.parse(localStorage.getItem("aiPsychTests") || "[]");

      const newTest = {
        id: `test_${Date.now()}`,
        category,
        content,
        createdAt: new Date().toLocaleString()
      };

      saved.unshift(newTest);
      if (saved.length > 20) {
        saved.pop();
      }

      localStorage.setItem("aiPsychTests", JSON.stringify(saved));
    }

    function loadSavedTests() {
      return JSON.parse(localStorage.getItem("aiPsychTests") || "[]");
    }

    function renderSavedTests() {
      const list = loadSavedTests();
      const box = document.getElementById("savedTestsSection");
      if (!box) return;

      if (list.length === 0) {
        box.innerHTML = '<div class="saved-tests-title">ì €ì¥ëœ í…ŒìŠ¤íŠ¸</div><p style="font-size:12px; color:#9ca3af;">ì•„ì§ ì €ì¥ëœ í…ŒìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      box.innerHTML =
        '<div class="saved-tests-title">ì €ì¥ëœ í…ŒìŠ¤íŠ¸</div>' +
        list
          .map(
            (t) => `
          <div class="saved-item">
            <div class="saved-item-header">
              <span class="saved-item-category">${t.category}</span>
              <span class="saved-item-date">${t.createdAt}</span>
            </div>
            <div class="saved-item-buttons">
              <button onclick="openSavedTest('${t.id}')">ì—´ê¸°</button>
              <button onclick="deleteSavedTest('${t.id}')">ì‚­ì œ</button>
            </div>
          </div>
        `
          )
          .join("");
    }

    let currentTestCategory = null;

    function openSavedTest(id) {
      const list = loadSavedTests();
      const t = list.find((x) => x.id === id);
      if (!t) {
        alert("ì €ì¥ëœ í…ŒìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const resultBox = document.getElementById('result');
      const placeholder = document.getElementById('placeholder');

      resultBox.style.display = 'block';
      placeholder.style.display = 'none';
      resultBox.textContent = t.content;
      currentTestCategory = t.category || null;

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteSavedTest(id) {
      let list = loadSavedTests();
      list = list.filter((x) => x.id !== id);
      localStorage.setItem("aiPsychTests", JSON.stringify(list));
      renderSavedTests();
    }

    /***********************
     *  í…ŒìŠ¤íŠ¸ í’€ì´ìš© ë¡œì§
     ***********************/
    const startQuizBtn = document.getElementById('startQuizBtn');
    const quizSection = document.getElementById('quizSection');
    const quizQuestionEl = document.getElementById('quizQuestion');
    const quizChoicesEl = document.getElementById('quizChoices');
    const quizProgressEl = document.getElementById('quizProgress');
    const quizPrevBtn = document.getElementById('quizPrevBtn');
    const quizNextBtn = document.getElementById('quizNextBtn');
    const quizSubmitBtn = document.getElementById('quizSubmitBtn');
    const quizResultEl = document.getElementById('quizResult');
    const quizAiResultEl = document.getElementById('quizAiResult');

    const downloadImageBtn = document.getElementById('downloadImageBtn');
    const resultCardWrapper = document.getElementById('resultCardWrapper');
    const resultCardEl = document.getElementById('resultCard');

    let parsedQuestions = [];
    let currentQuestionIndex = 0;
    let userAnswers = [];  // ê° ë¬¸í•­ ì„ íƒ ì¸ë±ìŠ¤ (0~3)
    let latestSummaryData = null;

    function parseTestTextToQuestions(text) {
      const lines = text
        .split('\n')
        .map(l => l.trim())
        .filter(l => l.length > 0);

      const questions = [];
      let current = null;

      for (const line of lines) {
        if (line.includes('ê²°ê³¼ í•´ì„') || line.includes('ê²°ê³¼ ìœ í˜•') || line.startsWith('[ê²°ê³¼')) {
          break;
        }

        const qMatch = /^(\d+)[\.\)]\s*(.*)/.exec(line);
        const aMatch = /^([A-D])[)\.\-]\s*(.*)/.exec(line);

        if (qMatch) {
          if (current && current.choices.length > 0) {
            questions.push(current);
          }
          current = {
            number: qMatch[1],
            question: qMatch[2].trim(),
            choices: []
          };
        } else if (aMatch && current) {
          current.choices.push(`${aMatch[1]}) ${aMatch[2].trim()}`);
        }
      }

      if (current && current.choices.length > 0) {
        questions.push(current);
      }

      return questions;
    }

    function renderQuizQuestion() {
      if (!parsedQuestions.length) return;

      const q = parsedQuestions[currentQuestionIndex];
      quizProgressEl.textContent = `${currentQuestionIndex + 1} / ${parsedQuestions.length}`;
      quizQuestionEl.textContent = `Q${q.number}. ${q.question}`;

      quizChoicesEl.innerHTML = '';
      q.choices.forEach((choiceText, idx) => {
        const btn = document.createElement('button');
        btn.className = 'quiz-choice-btn';
        if (userAnswers[currentQuestionIndex] === idx) {
          btn.classList.add('selected');
        }
        btn.textContent = choiceText;

        btn.addEventListener('click', () => {
          userAnswers[currentQuestionIndex] = idx;
          renderQuizQuestion();
        });

        quizChoicesEl.appendChild(btn);
      });

      quizPrevBtn.disabled = currentQuestionIndex === 0;
      quizNextBtn.disabled = currentQuestionIndex === parsedQuestions.length - 1;
    }

    function startQuiz() {
      const resultBox = document.getElementById('result');
      const text = resultBox.textContent.trim();
      if (!text) {
        alert('ë¨¼ì € í…ŒìŠ¤íŠ¸ë¥¼ ìƒì„±í•˜ê±°ë‚˜, ê³µìœ  ë§í¬/ì €ì¥ëœ í…ŒìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¨ ë’¤ ì´ìš©í•´ ì£¼ì„¸ìš”.');
        return;
      }

      const qs = parseTestTextToQuestions(text);
      if (!qs.length) {
        alert('í˜„ì¬ í…ìŠ¤íŠ¸ì—ì„œ ë¬¸í•­ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ìƒì„± í›„ ì‹œë„í•´ ì£¼ì„¸ìš”.');
        return;
      }

      parsedQuestions = qs;
      userAnswers = new Array(qs.length).fill(null);
      currentQuestionIndex = 0;
      quizResultEl.style.display = 'none';
      quizAiResultEl.style.display = 'none';
      quizAiResultEl.textContent = '';
      resultCardWrapper.style.display = 'none';
      latestSummaryData = null;

      quizSection.style.display = 'block';
      renderQuizQuestion();

      window.scrollTo({
        top: quizSection.offsetTop - 40,
        behavior: 'smooth'
      });
    }

    startQuizBtn.addEventListener('click', startQuiz);

    quizPrevBtn.addEventListener('click', () => {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuizQuestion();
      }
    });

    quizNextBtn.addEventListener('click', () => {
      if (currentQuestionIndex < parsedQuestions.length - 1) {
        currentQuestionIndex++;
        renderQuizQuestion();
      }
    });

    async function requestAiAnalysis(summary) {
      try {
        const resultBox = document.getElementById('result');
        const testText = resultBox.textContent;

        quizAiResultEl.style.display = 'block';
        quizAiResultEl.textContent = 'AIê°€ ë‹¹ì‹ ì˜ ê²°ê³¼ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤... (1~3ì´ˆ ì •ë„ ê±¸ë¦´ ìˆ˜ ìˆì–´ìš”)';

        const res = await fetch('/api/analyze-result', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            category: currentTestCategory || selectedCategory,
            testText,
            summary
          })
        });

        if (!res.ok) {
          throw new Error('ê²°ê³¼ í•´ì„ API ì˜¤ë¥˜');
        }

        const data = await res.json();
        const text = typeof data.result === 'string' ? data.result : JSON.stringify(data.result, null, 2);
        quizAiResultEl.innerHTML = '<b>AI ì—”í„°í…Œì¸ë¨¼íŠ¸ í•´ì„</b>\n\n' + text;

        if (latestSummaryData) {
          renderResultCard(latestSummaryData, text);
        }
      } catch (err) {
        console.error(err);
        quizAiResultEl.textContent = 'AI í•´ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
      }
    }

    function renderResultCard(summaryData, aiText) {
      if (!resultCardEl || !resultCardWrapper) return;

      const shortAi = aiText
        .split('\n')
        .map(l => l.trim())
        .filter(l => l.length > 0)
        .slice(0, 6)
        .join('\n');

      const dateStr = new Date().toLocaleDateString('ko-KR');

      resultCardEl.innerHTML = `
        <div class="card-header">
          <div class="card-badge">${currentTestCategory || selectedCategory}</div>
          <div class="card-date">${dateStr}</div>
        </div>
        <div class="card-title">${summaryData.bestLetter || '-'} íƒ€ì… ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ ê²°ê³¼</div>
        <div class="card-subtitle">A:${summaryData.counts.A} Â· B:${summaryData.counts.B} Â· C:${summaryData.counts.C} Â· D:${summaryData.counts.D}</div>
        <div class="card-body">
          ${summaryData.summaryText.replace(/\n/g, '<br/>')}
        </div>
        <div class="card-ai-snippet">
          ${shortAi.replace(/\n/g, '<br/>')}
        </div>
        <div class="card-footer">ai-psych-test-clean â€¢ ì¬ë¯¸ë¡œë§Œ ì°¸ê³ í•˜ì„¸ìš” ğŸ˜„</div>
      `;
      resultCardWrapper.style.display = 'block';
    }

    quizSubmitBtn.addEventListener('click', () => {
      if (!parsedQuestions.length) return;

      const counts = { A: 0, B: 0, C: 0, D: 0 };

      parsedQuestions.forEach((q, idx) => {
        const answerIdx = userAnswers[idx];
        if (answerIdx == null) return;
        const choiceText = q.choices[answerIdx];
        const letter = choiceText.trim().charAt(0); // A/B/C/D
        if (counts[letter] !== undefined) {
          counts[letter]++;
        }
      });

      const entries = Object.entries(counts);
      const totalAnswered = entries.reduce((sum, [, v]) => sum + v, 0);

      const unanswered = parsedQuestions.length - totalAnswered;
      if (unanswered > 0) {
        const ok = confirm(`ë‹µì„ ê³ ë¥´ì§€ ì•Šì€ ë¬¸í•­ì´ ${unanswered}ê°œ ìˆìŠµë‹ˆë‹¤. ê·¸ëŒ€ë¡œ ê²°ê³¼ë¥¼ ë³´ì‹œê² ì–´ìš”?`);
        if (!ok) return;
      }

      let bestLetter = null;
      let bestCount = -1;
      for (const [letter, count] of entries) {
        if (count > bestCount) {
          bestLetter = letter;
          bestCount = count;
        }
      }

      const summaryText =
        'ì„ íƒ ê²°ê³¼ ìš”ì•½\n' +
        `ì´ ${parsedQuestions.length}ë¬¸í•­ ì¤‘ ${totalAnswered}ë¬¸í•­ì— ë‹µë³€í–ˆìŠµë‹ˆë‹¤.\n` +
        `A ì„ íƒ: ${counts.A}ê°œ, B ì„ íƒ: ${counts.B}ê°œ, C ì„ íƒ: ${counts.C}ê°œ, D ì„ íƒ: ${counts.D}ê°œ\n\n` +
        `ê°€ì¥ ë§ì´ ì„ íƒí•œ ìœ í˜•: ${bestLetter || '-'} íƒ€ì…\n` +
        'ìƒì„¸ í•´ì„ì€ ì•„ë˜ AI ì—”í„°í…Œì¸ë¨¼íŠ¸ ë¶„ì„ì„ ì°¸ê³ í•´ ì£¼ì„¸ìš”.';

      quizResultEl.style.display = 'block';
      quizResultEl.textContent = summaryText;

      latestSummaryData = {
        counts,
        totalQuestions: parsedQuestions.length,
        totalAnswered,
        bestLetter,
        summaryText
      };
      resultCardWrapper.style.display = 'none';

      const summaryForServer = {
        totalQuestions: parsedQuestions.length,
        totalAnswered,
        counts
      };

      requestAiAnalysis(summaryForServer);
    });

    // ì¹´ë“œ ì´ë¯¸ì§€ë¥¼ PNGë¡œ ì €ì¥
    downloadImageBtn.addEventListener('click', async () => {
      if (!resultCardWrapper || resultCardWrapper.style.display === 'none') {
        alert('ë¨¼ì € ê²°ê³¼ë¥¼ ìƒì„±í•œ ë’¤ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      if (typeof html2canvas === 'undefined') {
        alert('ì´ë¯¸ì§€ ìƒì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
        return;
      }
      try {
        const canvas = await html2canvas(resultCardEl, {
          scale: 2,
          backgroundColor: '#f5f5ff'
        });
        const link = document.createElement('a');
        link.download = `ai-psych-test-result-${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      } catch (e) {
        console.error(e);
        alert('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    /***********************
     *  ê¸°ì¡´ ìƒì„±/ë³µì‚¬ ê¸°ëŠ¥ + ê³µìœ  ë§í¬
     ***********************/
    const tabs = document.querySelectorAll('.tab');
    const generateBtn = document.getElementById('generateBtn');
    const regenerateBtn = document.getElementById('regenerateBtn');
    const copyBtn = document.getElementById('copyBtn');
    const shareLinkBtn = document.getElementById('shareLinkBtn');
    const resultBox = document.getElementById('result');
    const placeholder = document.getElementById('placeholder');
    const shareNotice = document.getElementById('shareNotice');

    let selectedCategory = 'ì—°ì•  ì‹¬ë¦¬í…ŒìŠ¤íŠ¸';
    let lastPayload = null;

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        selectedCategory = tab.dataset.value;
      });
    });

    async function callApi(category) {
      resultBox.style.display = 'block';
      resultBox.textContent = 'AIê°€ ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“œëŠ” ì¤‘ì…ë‹ˆë‹¤...\n(ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”)';
      placeholder.style.display = 'none';
      shareNotice.style.display = 'none';
      quizSection.style.display = 'none';

      quizResultEl.style.display = 'none';
      quizAiResultEl.style.display = 'none';
      quizAiResultEl.textContent = '';
      resultCardWrapper.style.display = 'none';
      latestSummaryData = null;

      try {
        const res = await fetch('/api/generate-test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ category })
        });

        if (!res.ok) {
          throw new Error('API ìš”ì²­ ì‹¤íŒ¨');
        }

        const data = await res.json();

        const text =
          typeof data.test === 'string'
            ? data.test
            : JSON.stringify(data.test, null, 2);

        resultBox.textContent = text;
        lastPayload = text;
        currentTestCategory = category;

        saveTest(category, text);
        renderSavedTests();
      } catch (err) {
        console.error(err);
        resultBox.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
      }
    }

    generateBtn.addEventListener('click', () => {
      callApi(selectedCategory);
    });

    regenerateBtn.addEventListener('click', () => {
      callApi(selectedCategory);
    });

    copyBtn.addEventListener('click', async () => {
      if (!resultBox.textContent.trim()) return;
      try {
        await navigator.clipboard.writeText(resultBox.textContent);
        alert('ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
      } catch (e) {
        alert('ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ëª¨ë°”ì¼/ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ ì£¼ì„¸ìš”)');
      }
    });

    // ê³µìœ  ë§í¬ ìƒì„±ìš© Base64 ìœ í‹¸
    function encodeBase64(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }
    function decodeBase64(str) {
      return decodeURIComponent(escape(atob(str)));
    }

    // ê³µìœ  ë§í¬ ë³µì‚¬
    shareLinkBtn.addEventListener('click', async () => {
      const text = resultBox.textContent.trim();
      if (!text) {
        alert('ë¨¼ì € í…ŒìŠ¤íŠ¸ë¥¼ ìƒì„±í•˜ê±°ë‚˜, ì €ì¥ëœ í…ŒìŠ¤íŠ¸/ê³µìœ  ë§í¬ë¡œ ë¶ˆëŸ¬ì˜¨ ë’¤ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.');
        return;
      }
      const payload = {
        category: currentTestCategory || selectedCategory,
        test: text
      };

      try {
        const json = JSON.stringify(payload);
        const encoded = encodeBase64(json);
        const url = `${location.origin}${location.pathname}?t=${encodeURIComponent(encoded)}`;

        await navigator.clipboard.writeText(url);
        alert('ê³µìœ  ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nì¹œêµ¬ì—ê²Œ ë³´ë‚´ì„œ ë°”ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ í’€ê²Œ í•  ìˆ˜ ìˆì–´ìš”.');
      } catch (e) {
        console.error(e);
        alert('ë§í¬ ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // URL íŒŒë¼ë¯¸í„°ì—ì„œ t ê°’ì„ ì½ì–´ì™€ ê³µìœ  í…ŒìŠ¤íŠ¸ ë¡œë“œ
    function tryLoadSharedTest() {
      const params = new URLSearchParams(location.search);
      const t = params.get('t');
      if (!t) return;

      try {
        const decoded = decodeBase64(decodeURIComponent(t));
        const obj = JSON.parse(decoded);

        if (!obj || !obj.test) return;

        resultBox.style.display = 'block';
        placeholder.style.display = 'none';
        resultBox.textContent = obj.test;
        currentTestCategory = obj.category || null;
        shareNotice.style.display = 'block';

        // íƒ­ë„ ì¹´í…Œê³ ë¦¬ì— ë§ì¶°ì„œ í•˜ì´ë¼ì´íŠ¸ (ìˆìœ¼ë©´)
        if (obj.category) {
          tabs.forEach(tab => {
            if (tab.dataset.value === obj.category) {
              tabs.forEach(t => t.classList.remove('active'));
              tab.classList.add('active');
              selectedCategory = obj.category;
            }
          });
        }
      } catch (e) {
        console.error('ê³µìœ  ë§í¬ íŒŒì‹± ì˜¤ë¥˜', e);
      }
    }

    // ì´ˆê¸° ì‹¤í–‰
    renderSavedTests();
    tryLoadSharedTest();
  </script>
</body>
</html>
